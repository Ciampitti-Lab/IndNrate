<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ciampitti Lab</title>
    <link rel="stylesheet" href="static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body>

    {% include 'header.html' %}

    <div id="map" style="height: 650px; margin: 10px 0; border-radius: 6px; overflow: hidden;"></div>

    <!-- MODAL -->
    <div class="modal-bg" id="modalAONR">
        <div class="modal-box">
            <span class="close-btn" onclick="closeModal()">×</span>
            <h3 style="margin-top: 5px; text-align:center;">AONR / EONR Chart</h3>

            <!-- Prices -->
            <div id="priceInputs" style="text-align:center; margin-bottom:10px;">
                <label>Grain Price (USD/ton): </label>
                <input type="number" id="grainPrice" value="200" step="any" style="width:80px; margin-right:10px;">
                <label>N price (USD/kg): </label>
                <input type="number" id="nPrice" value="1" step="any" style="width:80px; margin-right:10px;">
                <button onclick="calculateEONR()" style="padding:5px 10px;">Calculate EONR</button>
            </div>

            <!-- Iframe EONR -->
            <iframe id="plotIframe" src="" style="width:100%; height:500px; border:none; border-radius: 8px;"></iframe>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    var lat = 40.2732;
    var lon = -86.1260;
    var zoom = 7;

    var map = L.map('map').setView([lat, lon], zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
        maxZoom: 19, 
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors' 
    }).addTo(map);

    L.control.scale().addTo(map);

    var regionColors = {
        'NC': '#2ca02c',
        'NE': '#ff7f0e',
        'C': '#1f77b4'
    };

    fetch("static/cells_indiana.geojson")
    .then(response => response.json())
    .then(data => {
        L.geoJSON(data, {
            style: function(feature) {
                var region = feature.properties.region;
                return {
                    color: regionColors[region] || '#3388ff',
                    weight: 2,
                    fillOpacity: 0.01
                };
            },
            onEachFeature: function(feature, layer) {
                var countyname = feature.properties.countyname;
                var cellId = feature.properties.id_cell; 

                var popupContent = `
                    <strong>County:</strong> ${countyname}<br>
                    <button onclick="generateFig(${cellId})">
                        Calculate AONR
                    </button>
                `;
                layer.bindPopup(popupContent);
            }
        }).addTo(map);
    });

});

var currentCellId = null;  

function generateFig(cellId) {
    currentCellId = cellId;  
    fetch(`/generate_fig?cell=${cellId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById("plotIframe").src = data.url;
            document.getElementById("modalAONR").style.display = "flex";
        })
        .catch(error => console.error(error));
}

function calculateEONR() {
    if (!currentCellId) return;
    var grainPrice = parseFloat(document.getElementById("grainPrice").value);
    var nPrice = parseFloat(document.getElementById("nPrice").value);

    fetch(`/generate_eonr_fig?cell=${currentCellId}&grain_price=${grainPrice}&n_price=${nPrice}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById("plotIframe").src = data.url;
        })
        .catch(error => console.error(error));
}

function closeModal() {
    document.getElementById("modalAONR").style.display = "none";
}
</script>

<footer>
    © 2025 Ciampitti Lab, Purdue University. All rights reserved. <br>
    Website Developed by Jorge Jola.
</footer>

</body>
</html>
